# Локализация времени в JavaScript

Давайте представим, что у вас есть определенное **время**, которое вы хотели бы отобразить на своем сайте. Время имеет формат *вашего* часового пояса. Конечно, вы можете показывать его с явным указанием часового пояса, скажем так — **3:00 PM Eastern Standard Time**. В таком случае каждый посетитель вашего сайте будет вынужден вручную конвертировать время с поправкой на свой часовой пояс ну или использовать этот отличный ресурс - [Every Time Zone]([1])

Но разработчик ведь может позаботиться о пользователе и локализовать время в соответствии с его часовым поясом, избавив его от необходимости делать это самостоятельно. Тем более, что у него есть для этого отличный инструмент - JavaScript.

Уверен, для этого существует множество способов. Недавно мне пришлось столкнулся с подобной задачей на одном новом проекте и я решил перенять опыт локализации дат у ребят из [ShopTalk]([2]).


### Библиотеки

[Moment.js]([3]) и [Moment Timezone]([4]) - прекрасно подходят для решения задач, связанных с локализацией дат и различных манипуляций с ними. Например, с их помощью можно легко представить время в подобных форматах: "32 minutes ago", "12 de Agosto de 2015".

Еще один важный момент заключается в том, что было бы неплохо автоматически определять текущий часовой пояс пользователя. К счастью, для этого есть [отличное средство]([5]).

Итак, мы будем использовать:
* jstz.js
* moment.js
* moment-timezone.js


### Шаг 1: Получение часового пояса 

После получения часового пояса можем хранить его в `localStorage`, что бы проще было получить его из любой точки приложения.

    if (!sessionStorage.getItem('timezone')) {
        var tz = jstz.determine() || 'UTC';
        sessionStorage.setItem('timezone', tz.name());
    }
    var currTz = sessionStorage.getItem('timezone');


### Шаг 2: Получение времени

Когда мы создаем объект Moment, сначала выполняется проверка переданной в качестве аргумента строки на соответствие формату [ISO 8601]([9]). Для [UTC]([6]) этот формат имеет следующий вид (обратите внимание на символ 'Z' стоящий сразу же после значения времени):

    2015-08-12T14:30Z

Используя Moment, можно легко изменять формат дат. Давайте рассмотрим небольшой пример. По умолчанию Moment создает объект, основанный на текущей дате, который мы преобразуем в строку нужного формата.

    var date = moment().format("YYYY-MM-DD");
    
Затем, если необходимо, добавим к получившейся строке время в формате `TH:mm`:

    var stamp = date + "T" + theTime + "Z";

И, наконец, преобразуем строку в новый объект Moment:

    var momentTime = moment(stamp);


### Шаг 3: Локализация времени

Теперь давайте посмотрим как можно использовать Moment Timezone для локализации времени:

    var tzTime = momentTime.tz(currTz);
    
И, конечно же, отформатируем получившееся значение для более удобного отображения:

    var formattedTime = tzTime.format('h:mm A');


### Шаг 4: Использование

Ну что же, теперь мы можем использовать описанный подход на любом сайте. Вместе с отформатированным временем вы можете отображать и текущий часовой пояс. Если же определение таймзоны по каким-то причинам завершилось неудачей, то время отобразится в UTC формате.

    output.textContent = "Time in " + currTz + ": " + formattedTime;


### Дополнительная настройка

Иногда бывает полезно предоставлять пользователям возможность вводить даты на сайте в их локальном часовом поясе. Но, хранить подобную информацию удобнее в формате UTC. Moment может сделать это достаточно легко с помощью методов, которые позволяют выполнять почасовой сдвиг:

    moment().subtract(4, 'hours');
    moment().add(3, 'hours');
    
Мы можем выполнить подобные манипуляции и на сервере, используя, например, PHP:

    <?php $sixHoursAgo = strtotime("-6 hours", time()); ?>
    
Хотя, в подобных преобразованиях лучше использовать [Moment Timezone]([7]), чтобы избежать неточностей, связанных с переводом времени на летнее. 


### Пример

В примере ниже мы будем использовать HTML5 time editor и конвертировать время в локальное на лету.

<p data-height="268" data-theme-id="0" data-slug-hash="YwvvrP" data-default-tab="result" data-user="FMRobot" class='codepen'>Посмотреть на CodePen: <a href='http://codepen.io/FMRobot/pen/YwvvrP/'>Приведение времени в соответствие локальному часовому поясу</a>.</p>

    
### Другие способы локализации

У вас есть опыт решения задач локализации времени? В статье мы использовали довольно объемные сторонние библиотеки, хотя в JavaScript уже есть нативные методы (например, [getTimezoneOffset()]([8])), с помощью которых можно добиться аналогичных результатов. Было бы интересно увидеть ваши решения, напишите о них в комментариях.


 [1]: http://everytimezone.com/
 [2]: http://shoptalkshow.com/
 [3]: http://momentjs.com/
 [4]: http://momentjs.com/timezone/
 [5]: https://bitbucket.org/pellepim/jstimezonedetect
 [6]: https://en.wikipedia.org/wiki/Coordinated_Universal_Time
 [7]: http://momentjs.com/timezone/
 [8]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/getTimezoneOffset
 [9]: https://en.wikipedia.org/wiki/ISO_8601
